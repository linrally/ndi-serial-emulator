import serial

ndi = serial.Serial("/dev/cu.usbserial-2130", baudrate=9600, bytesize=8, parity="N", stopbits=1, dsrdtr=False)

ndi.send_break()

rx_bytes = bytearray()
rx_msg = bytearray()
rx_printed_last = None

sent_init = False
asked_version = False
changed_rate = False
sent_echo = False

def calc_crc16(data):
	crc = 0x0000
	for i in (range(0, len(data))):
		crc ^= data[i]
		for k in range(0, 8):
			crc = (crc >> 1) ^ 0xa001 if crc & 1 else crc >> 1
	return crc

def append_crc16(strdata):
	return (strdata + calc_crc16(strdata.encode()).to_bytes(2).hex().upper() + "\r")

ndi.send_break()
assert ndi.read_until("\r".encode()) == "RESETBE6F\r".encode()

ndi.write(append_crc16("INIT:").encode())
assert ndi.read_until("\r".encode()) == "OKAYA896\r".encode()

ndi.write(append_crc16("VER:4").encode())
print("VER: ", ndi.read_until("\r".encode()))

ndi.write(append_crc16("COMM:60000").encode())
assert ndi.read_until("\r".encode()) == "OKAYA896\r".encode()
ndi.baudrate = 921600

def test_cmd(cmdstr):
	ndi.write(append_crc16(f"{cmdstr}").encode())
	print(f"{cmdstr}: ", ndi.read_until("\r".encode()))

test_cmd("GET:Info.Status.Alerts")
test_cmd("PHRQ:*********1****")
test_cmd("PVWR:0000004E444900E127000001000000030000010000000002C4AA3B5000000003000000030000000000803F000000000000000000000000000000000000000000000000")
test_cmd("PVWR:00004000002041000000000000483800509C3BD55D8CB40052A6BDB9FB8B429559433564347042807101BE5555FAB40000000000000000000000000000000000000000")
test_cmd("PVWR:00008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")
test_cmd("PVWR:0000C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")
test_cmd("PVWR:00010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006746683156C072B2")
test_cmd("PVWR:0001400000803F6746683156C072B20000803F6746683156C072B20000803F000000000000000000000000000000000000000000000000000000000000000000000000")
test_cmd("PVWR:00018000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")
test_cmd("PVWR:0001C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")
test_cmd("PVWR:0002000000000000000000000000000000000000000000000000000000000000000000000000000000000000010200000000000000000000000000000000001F1F1F1F")
test_cmd("PVWR:00024009000000487962657800000000000000535431323537000000000000000000000000000009010101000000000000000000000000000000000001010100000000")
test_cmd("PVWR:000280000000000000000000000000008200296746683156C072B20000803F000000000000000000000000000000000000000000000000000000000000000000000000")
test_cmd("PVWR:0002C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")
test_cmd("PINIT:00")
test_cmd("PENA:00")
test_cmd("TSTART:")
test_cmd("BX:0001")